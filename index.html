<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Railway Map Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .editor-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            max-width: 300px;
        }
        
        .editor-panel h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }
        
        .editor-panel input, .editor-panel select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .editor-panel button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .btn-finish {
            background: #2196F3;
            color: white;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-save {
            background: #FF9800;
            color: white;
        }
        
        .btn-disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .info-text {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
        }
        
        .coordinates-count {
            font-size: 14px;
            color: #2196F3;
            font-weight: bold;
        }
        
        .mapboxgl-popup-content {
            padding: 15px;
            min-width: 200px;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .popup-row {
            margin: 5px 0;
            font-size: 14px;
        }
        .popup-label {
            color: #666;
            font-weight: 500;
        }
    </style>
</head>
<body>
<div id='map'></div>

<div class="editor-panel">
    <h3>ğŸš† è·¯ç·šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h3>
    
    <div id="input-section">
        <input type="text" id="line-name" placeholder="è·¯ç·šå (ä¾‹: å±±æ‰‹ç·š)">
        <input type="text" id="operator-name" placeholder="é‹å–¶ä¼šç¤¾ (ä¾‹: æ±æ—¥æœ¬æ—…å®¢é‰„é“)">
        
        <select id="operator-type">
            <option value="">äº‹æ¥­è€…åŒºåˆ†ã‚’é¸æŠ</option>
            <option value="1">JRæ–°å¹¹ç·š</option>
            <option value="2">JRåœ¨æ¥ç·š</option>
            <option value="3">å…¬å–¶é‰„é“</option>
            <option value="4">æ°‘å–¶é‰„é“</option>
            <option value="5">ç¬¬ä¸‰ã‚»ã‚¯ã‚¿ãƒ¼</option>
        </select>
        
        <select id="railway-type">
            <option value="">è·¯ç·šç¨®é¡ã‚’é¸æŠ</option>
            <option value="11">JR</option>
            <option value="12">æ™®é€šé‰„é“</option>
            <option value="21">è»Œé“</option>
            <option value="22">æ‡¸å‚å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
            <option value="23">è·¨åº§å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
        </select>
        
        <input type="color" id="line-color" value="#0066ff">
        <label for="line-color" style="font-size: 12px;">è·¯ç·šã‚«ãƒ©ãƒ¼</label>
    </div>
    
    <div class="info-text" id="status-text">
        è·¯ç·šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œæç”»é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    </div>
    
    <div class="coordinates-count" id="coord-count">
        åº§æ¨™æ•°: 0
    </div>
    
    <button class="btn-start" id="btn-start" onclick="startDrawing()">
        ğŸ“ æç”»é–‹å§‹
    </button>
    
    <button class="btn-finish btn-disabled" id="btn-finish" onclick="finishDrawing()" disabled>
        âœ“ è·¯ç·šå®Œæˆ
    </button>
    
    <button class="btn-cancel btn-disabled" id="btn-cancel" onclick="cancelDrawing()" disabled>
        âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
    
    <button class="btn-save" id="btn-save" onclick="saveToFile()">
        ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    </button>
</div>

<script>
// Mapbox ì•¡ì„¸ìŠ¤ í† í° ì„¤ì •
mapboxgl.accessToken = 'pk.eyJ1IjoibG9zdGNhZmUwIiwiYSI6ImNsMnBoOHpyMTAyMzczY254MmthZG1rOWEifQ.p_Xuk6AkxC7C9W4CPBwrjA';

// ì„ ë¡œ ìƒ‰ìƒ ë§¤í•‘
const lineColorMap = {
    "å°ç”°åŸç·š": "#0085CE",
    "æ±Ÿãƒå³¶ç·š": "#0085CE",
    "å¤šæ‘©ç·š": "#0085CE",
    "å¤šæ‘©ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«": "#286460",
    "ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒ³": "#0070C0",
    "ã‚°ãƒªãƒ¼ãƒ³ãƒ©ã‚¤ãƒ³": "#00B050",
    "ç§‹ç”°æ–°å¹¹ç·š": "#ED4399",
    "å·¦æ²¢ç·š": "#0073BF",
    "ç£è¶Šæ±ç·š": "#C71585",
    "ç£è¶Šè¥¿ç·š": "#CB7B35",
    "ä¸¸ãƒå†…ç·š": "#F62E36",
    "åƒä»£ç”°ç·š": "#00BB85",
    "å—åŒ—ç·š": "#00AC9B",
    "å‰¯éƒ½å¿ƒç·š": "#9C5E31",
    "éŠ€åº§ç·š": "#FF9500",
    "åŠè”µé–€ç·š": "#8F76D6",
    "æ—¥æ¯”è°·ç·š": "#B5B5AC",
    "æ±è¥¿ç·š": "#009BBF",
    "æœ‰æ¥½ç”ºç·š": "#C1A470",
    "ä¸¸ãƒå†…ç·šæ”¯ç·š": "#F62E36",
    "ä¸­å¤®ãƒ»ç·æ­¦å„é§…åœè»Š": "#FFE500",
    "ä¸­å¤®æœ¬ç·š": "#0071C5",
    "å¸¸ç£ç·š": "#0071C5",
    "å¾å¦»ç·š": "#008689",
    "ä¸­å¤®ç·šå¿«é€Ÿ": "#EB5C01",
    "å…«é«˜ç·š": "#A09D95",
    "ä¼Šæ±ç·š": "#FF9845",
    "å·è¶Šç·š(å·è¶Š-é«˜éº—å·é–“)": "#A6A9AB",
    "äº”æ—¥å¸‚ç·š": "#EB5C01",
    "å¸¸ç£ç·šå„é§…åœè»Š": "#9E9E9F",
    "å¸¸ç£ç·šå¿«é€Ÿ": "#00C18A",
    "ä¸Šè¶Šç·š": "#00ACD1",
    "é¹¿å³¶ç·š": "#A85F12",
    "äº¬æµœæ±åŒ—ç·šãƒ»æ ¹å²¸ç·š": "#00A7E3",
    "äº¬è‘‰ç·š": "#CF1225",
    "ä¹…ç•™é‡Œç·š": "#00C3A7",
    "æˆç”°ç·š": "#00BB85",
    "æ­¦è”µé‡ç·š": "#EB5C01",
    "å—æ­¦ç·šæµœå·å´æ”¯ç·š": "#FFE400",
    "å—æ­¦ç·š": "#FFE400",
    "æˆç”°ç·šæˆ‘å­«å­æ”¯ç·š": "#00BB85",
    "æˆç”°ç·šç©ºæ¸¯æ”¯ç·š": "#00BB85",
    "é’æ¢…ç·š": "#EB5C01",
    "ç›¸æ¨¡ç·š": "#008689",
    "åŸ¼äº¬ç·šãƒ»å·è¶Šç·š": "#00AC84",
    "æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³": "#DE0515",
    "ç·æ­¦å¿«é€Ÿç·š": "#0074BE",
    "ç·æ­¦æœ¬ç·š": "#FDD700",
    "ç›¸é‰„ç›´é€šç·š": "#00C3A7",
    "å¤–æˆ¿ç·š": "#F22335",
    "é«˜å´ç·š": "#FF9845",
    "æ±é‡‘ç·š": "#B31C31",
    "æ±æµ·é“ç·š": "#FF9845",
    "é¶´è¦‹ç·šå¤§å·æ”¯ç·š": "#FFE500",
    "é¶´è¦‹ç·šæµ·èŠæµ¦æ”¯ç·š": "#FFE500",
    "é¶´è¦‹ç·š": "#FFE500",
    "å†…æˆ¿ç·š": "#0071C5",
    "å®‡éƒ½å®®ç·š": "#FF9845",
    "å±±æ‰‹ç·š": "#85C023",
    "æ¨ªæµœç·š": "#85C023",
    "æ¨ªé ˆè³€ç·š": "#0074BE",
    "æµ…è‰ç·š": "#FF535F",
    "ä¸‰ç”°ç·š": "#0067B0",
    "å¤§æ±Ÿæˆ¸ç·š": "#CF3366",
    "æ–°å®¿ç·š": "#9FB01C",
    "æ—¥å…‰ç·š": "#F5A302",
    "æ±æ­¦ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ãƒ©ã‚¤ãƒ³": "#226BB8",
    "å¤§å¸«ç·š": "#226BB8",
    "ä¼Šå‹¢å´ç·š": "#E62119",
    "æ¡ç”Ÿç·š": "#E62119",
    "äº€æˆ¸ç·š": "#226BB8",
    "é¬¼æ€’å·ç·š": "#F5A302",
    "ã‚†ã‚Šã‹ã‚‚ã‚": "#0065A6",
    "å°æ³‰ç·š(æ±å°æ³‰-å¤ªç”°)": "#E62119",
    "å°æ³‰ç·š": "#E62119",
    "è¶Šç”Ÿç·š": "#10428B",
    "ä½é‡ç·š": "#E62119",
    "æ±æ­¦ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ãƒ©ã‚¤ãƒ³(æŠ¼ä¸Š-æ›³èˆŸ)": "#226BB8",
    "æ±æ­¦ã‚¢ãƒ¼ãƒãƒ³ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³": "#41B3E5",
    "æ±ä¸Šç·š": "#10428B",
    "å®‡éƒ½å®®ç·š": "#F5A302",
    "äº¬æ€¥æœ¬ç·š": "#0DB0E9",
    "ç©ºæ¸¯ç·š": "#0DB0E9",
    "å¤§å¸«ç·š": "#0DB0E9",
    "ä¹…é‡Œæµœç·š": "#0DB0E9",
    "é€—å­ç·š": "#0DB0E9",
    "ã‚Šã‚“ã‹ã„ç·š": "#222D65",
    "æ±æ€¥å¤šæ‘©å·ç·š": "#AE0379",
    "æ±æ¨ªç·š": "#DB0442",
    "è±Šå³¶ç·š": "#FF710A",
    "ã„ãšã¿é‡ç·š": "#0073BC",
    "ç›¸é‰„æœ¬ç·š": "#0073BC",
    "ç›¸é‰„æ–°æ¨ªæµœç·š": "#0073BC",
    "æ‹å³¶ç·š": "#00A8B5",
    "æ± è¢‹ç·š": "#FF710A",
    "å›½åˆ†å¯ºç·š": "#00A943",
    "ç‹­å±±ç·š": "#FF710A",
    "è¥¿æ­¦ç§©çˆ¶ç·š": "#FF710A",
    "è¥¿æ­¦æœ‰æ¥½ç”ºç·š": "#FF710A",
    "è¥¿æ­¦åœ’ç·š": "#00A943",
    "æ–°å®¿ç·š": "#00A8B5",
    "å¤šæ‘©å·ç·š": "#FF710A",
    "ç”°åœ’éƒ½å¸‚ç·š": "#00AA8E",
    "æ± ä¸Šç·š": "#EE86A7",
    "ä¸–ç”°è°·ç·š": "#FCC80D",
    "ã“ã©ã‚‚ã®å›½ç·š": "#0071BE",
    "ç›®é»’ç·š": "#009CD3",
    "å¤§äº•ç”ºç·š": "#F18C43",
    "æ±æ€¥æ–°æ¨ªæµœç·š": "#890D84",
    "å¤šæ‘©æ¹–ç·š": "#FFA600",
    "å±±å£ç·š": "#FF565D"
};

// ì‚¬ì—…ì êµ¬ë¶„ ì½”ë“œ ë§¤í•‘
const operatorTypeMap = {
    "1": "JRæ–°å¹¹ç·š", 
    "2": "JRåœ¨æ¥ç·š", 
    "3": "å…¬å–¶é‰„é“", 
    "4": "æ°‘å–¶é‰„é“", 
    "5": "ç¬¬ä¸‰ã‚»ã‚¯ã‚¿ãƒ¼" 
};

// ë…¸ì„  ì¢…ë¥˜ êµ¬ë¶„ ì½”ë“œ ë§¤í•‘
const railwayTypeMap = { 
    "11": "JR", 
    "12": "æ™®é€šé‰„é“", 
    "13": "é‹¼ç´¢é‰„é“", 
    "14": "æ‡¸å‚å¼é‰„é“", 
    "15": "è·¨åº§å¼é‰„é“", 
    "16": "æ¡ˆå†…è»Œæ¡å¼é‰„é“", 
    "17": "ç„¡è»Œæ¡é‰„é“", 
    "21": "è»Œé“", 
    "22": "æ‡¸å‚å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«", 
    "23": "è·¨åº§å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«", 
    "24": "æ¡ˆå†…è»Œæ¡å¼", 
    "25": "æµ®ä¸Šå¼" 
};

// í¸ì§‘ ìƒíƒœ ê´€ë¦¬
let isDrawing = false;
let currentCoordinates = [];
let rawData = []; // ì›ë³¸ ë°ì´í„° ì €ì¥
let geojsonData = null; // ë³€í™˜ëœ GeoJSON ë°ì´í„°

// ìƒ‰ìƒ ì°¾ê¸° í•¨ìˆ˜
function getLineColor(label) {
    if (lineColorMap[label]) {
        return lineColorMap[label];
    }
    if (label.startsWith('JR')) {
        const labelWithoutJR = label.substring(2);
        if (lineColorMap[labelWithoutJR]) {
            return lineColorMap[labelWithoutJR];
        }
    }
    return '#0066ff';
}

// ì¢Œí‘œ ì •ê·œí™” í•¨ìˆ˜
function normalizeCoordinates(coords) {
    if (Array.isArray(coords[0]) && Array.isArray(coords[0][0])) {
        return coords;
    } else {
        return [coords];
    }
}

// GeoJSON íŒŒì¼ ë¡œë“œ ë° ë³€í™˜
async function loadAndConvertGeoJSON(url) {
    const response = await fetch(url);
    const data = await response.json();
    rawData = data; // ì›ë³¸ ë°ì´í„° ì €ì¥
    
    return {
        'type': 'FeatureCollection',
        'features': data.map(railway => ({
            'type': 'Feature',
            'properties': {
                'label': railway.label,
                'operator': railway.N02_004,
                'operatorType': railway.N02_002,
                'railwayType': railway.N02_001,
                'color': getLineColor(railway.label)
            },
            'geometry': {
                'type': 'MultiLineString',
                'coordinates': normalizeCoordinates(railway.coordinates)
            }
        }))
    };
}

// ë§µ ì´ˆê¸°í™”
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/lostcafe0/cmgyogzdq007201r59ni6b9fd',
    center: [135, 35],
    zoom: 5
});

// ê·¸ë¦¬ê¸° ì‹œì‘
function startDrawing() {
    const lineName = document.getElementById('line-name').value;
    const operatorName = document.getElementById('operator-name').value;
    const operatorType = document.getElementById('operator-type').value;
    const railwayType = document.getElementById('railway-type').value;
    
    if (!lineName || !operatorName || !operatorType || !railwayType) {
        alert('ã™ã¹ã¦ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    isDrawing = true;
    currentCoordinates = [];
    
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-start').classList.add('btn-disabled');
    document.getElementById('btn-finish').disabled = false;
    document.getElementById('btn-finish').classList.remove('btn-disabled');
    document.getElementById('btn-cancel').disabled = false;
    document.getElementById('btn-cancel').classList.remove('btn-disabled');
    document.getElementById('input-section').style.opacity = '0.5';
    document.getElementById('status-text').textContent = 'åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åº§æ¨™ã‚’è¿½åŠ ';
    
    map.getCanvas().style.cursor = 'crosshair';
}

// ê·¸ë¦¬ê¸° ì™„ë£Œ
function finishDrawing() {
    if (currentCoordinates.length < 2) {
        alert('æœ€ä½2ã¤ã®åº§æ¨™ãŒå¿…è¦ã§ã™');
        return;
    }
    
    const lineName = document.getElementById('line-name').value;
    const operatorName = document.getElementById('operator-name').value;
    const operatorType = document.getElementById('operator-type').value;
    const railwayType = document.getElementById('railway-type').value;
    const lineColor = document.getElementById('line-color').value;
    
    // ì›ë³¸ ë°ì´í„°ì— ì¶”ê°€
    const newRailway = {
        label: lineName,
        N02_004: operatorName,
        N02_002: operatorType,
        N02_001: railwayType,
        coordinates: currentCoordinates
    };
    
    rawData.push(newRailway);
    
    // GeoJSONì— ì¶”ê°€
    const newFeature = {
        'type': 'Feature',
        'properties': {
            'label': lineName,
            'operator': operatorName,
            'operatorType': operatorType,
            'railwayType': railwayType,
            'color': lineColor
        },
        'geometry': {
            'type': 'MultiLineString',
            'coordinates': [currentCoordinates]
        }
    };
    
    geojsonData.features.push(newFeature);
    
    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);
    
    // ìƒíƒœ ë¦¬ì…‹
    resetDrawing();
    
    alert(`è·¯ç·šã€Œ${lineName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nåº§æ¨™æ•°: ${currentCoordinates.length}`);
}

// ê·¸ë¦¬ê¸° ì·¨ì†Œ
function cancelDrawing() {
    if (currentCoordinates.length > 0) {
        if (!confirm('æç”»ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }
    }
    
    // ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
    
    resetDrawing();
}

// ìƒíƒœ ë¦¬ì…‹
function resetDrawing() {
    isDrawing = false;
    currentCoordinates = [];
    
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').classList.remove('btn-disabled');
    document.getElementById('btn-finish').disabled = true;
    document.getElementById('btn-finish').classList.add('btn-disabled');
    document.getElementById('btn-cancel').disabled = true;
    document.getElementById('btn-cancel').classList.add('btn-disabled');
    document.getElementById('input-section').style.opacity = '1';
    document.getElementById('status-text').textContent = 'è·¯ç·šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œæç”»é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
    document.getElementById('coord-count').textContent = 'åº§æ¨™æ•°: 0';
    
    map.getCanvas().style.cursor = '';
    
    // ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
}

// íŒŒì¼ë¡œ ì €ì¥
function saveToFile() {
    if (rawData.length === 0) {
        alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const dataStr = JSON.stringify(rawData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'railway_data_updated.json';
    link.click();
    URL.revokeObjectURL(url);
    
    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
}

// ì„ì‹œ ì„  ì—…ë°ì´íŠ¸
function updateTempLine() {
    if (currentCoordinates.length === 0) return;
    
    const lineColor = document.getElementById('line-color').value;
    
    // ê¸°ì¡´ ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
    
    // ì„ì‹œ ì„  ì¶”ê°€
    map.addSource('temp-line', {
        'type': 'geojson',
        'data': {
            'type': 'Feature',
            'geometry': {
                'type': 'LineString',
                'coordinates': currentCoordinates
            }
        }
    });
    
    map.addLayer({
        'id': 'temp-line',
        'type': 'line',
        'source': 'temp-line',
        'paint': {
            'line-color': lineColor,
            'line-width': 4,
            'line-dasharray': [2, 2]
        }
    });
    
    // ì„ì‹œ ì  ì¶”ê°€
    map.addSource('temp-points', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': currentCoordinates.map(coord => ({
                'type': 'Feature',
                'geometry': {
                    'type': 'Point',
                    'coordinates': coord
                }
            }))
        }
    });
    
    map.addLayer({
        'id': 'temp-points',
        'type': 'circle',
        'source': 'temp-points',
        'paint': {
            'circle-radius': 5,
            'circle-color': lineColor,
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff'
        }
    });
}

map.on('load', async () => {
    try {
        // GeoJSON íŒŒì¼ ë¡œë“œ
        geojsonData = await loadAndConvertGeoJSON('Arcgis_railroad_extracted.json');
        
        // ë°ì´í„° ì†ŒìŠ¤ ì¶”ê°€
        map.addSource('railways', {
            'type': 'geojson',
            'data': geojsonData
        });

        // ë ˆì´ì–´ ì¶”ê°€
        map.addLayer({
            'id': 'railway-lines',
            'type': 'line',
            'source': 'railways',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': ['get', 'color'],
                'line-width': 3
            }
        });

        // í´ë¦­ ì´ë²¤íŠ¸ - ê·¸ë¦¬ê¸° ëª¨ë“œì™€ ì¼ë°˜ ëª¨ë“œ êµ¬ë¶„
        map.on('click', (e) => {
            if (isDrawing) {
                // ê·¸ë¦¬ê¸° ëª¨ë“œ: ì¢Œí‘œ ì¶”ê°€
                currentCoordinates.push([e.lngLat.lng, e.lngLat.lat]);
                document.getElementById('coord-count').textContent = `åº§æ¨™æ•°: ${currentCoordinates.length}`;
                updateTempLine();
            } else {
                // ì¼ë°˜ ëª¨ë“œ: ì„ ë¡œ ì •ë³´ í‘œì‹œ
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['railway-lines']
                });
                
                if (features.length > 0) {
                    const properties = features[0].properties;
                    const operatorTypeName = operatorTypeMap[properties.operatorType] || properties.operatorType;
                    const railwayTypeName = railwayTypeMap[properties.railwayType] || properties.railwayType;
                    
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div class="popup-title">${properties.label}</div>
                            <div class="popup-row">
                                <span class="popup-label">é‹å–¶ä¼šç¤¾:</span> ${properties.operator}
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">äº‹æ¥­è€…åŒºåˆ†:</span> ${operatorTypeName}
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">è·¯ç·šç¨®é¡:</span> ${railwayTypeName}
                            </div>
                        `)
                        .addTo(map);
                }
            }
        });

        // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½
        map.on('mouseenter', 'railway-lines', () => {
            if (!isDrawing) {
                map.getCanvas().style.cursor = 'pointer';
            }
        });
        map.on('mouseleave', 'railway-lines', () => {
            if (!isDrawing) {
                map.getCanvas().style.cursor = '';
            }
        });

        // ì „ì²´ ë…¸ì„ ì´ ë³´ì´ë„ë¡ ë§µ ì¡°ì •
        const bounds = new mapboxgl.LngLatBounds();
        geojsonData.features.forEach(feature => {
            feature.geometry.coordinates.forEach(line => {
                line.forEach(coord => {
                    bounds.extend(coord);
                });
            });
        });
        map.fitBounds(bounds, { padding: 50 });
        
    } catch (error) {
        console.error('GeoJSON ë¡œë“œ ì‹¤íŒ¨:', error);
    }
});
</script>
</body>
</html>
