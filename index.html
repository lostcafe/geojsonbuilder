<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Railway Map Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        .editor-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            max-width: 300px;
        }
        
        .editor-panel h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }
        
        .editor-panel input, .editor-panel select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .editor-panel button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-start {
            background: #4CAF50;
            color: white;
        }
        
        .btn-finish {
            background: #2196F3;
            color: white;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-save {
            background: #FF9800;
            color: white;
        }
        
        .btn-disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .info-text {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
        }
        
        .coordinates-count {
            font-size: 14px;
            color: #2196F3;
            font-weight: bold;
        }
        
        .mapboxgl-popup-content {
            padding: 15px;
            min-width: 200px;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .popup-row {
            margin: 5px 0;
            font-size: 14px;
        }
        .popup-label {
            color: #666;
            font-weight: 500;
        }

        .btn-edit-mode {
            background: #9C27B0;
            color: white;
        }

        .coordinate-editor {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        .coordinate-editor.active {
            display: block;
        }

        .coord-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .coord-item {
            background: #f5f5f5;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .coord-info {
            flex: 1;
            margin-right: 10px;
        }

        .coord-actions {
            display: flex;
            gap: 5px;
        }

        .coord-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }

        .btn-edit-coord {
            background: #2196F3;
            color: white;
        }

        .btn-delete-coord {
            background: #f44336;
            color: white;
        }

        .btn-close-editor {
            background: #666;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .edit-form {
            background: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 2px solid #ffc107;
        }

        .edit-form input {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .edit-form button {
            width: 48%;
            padding: 8px;
            margin: 2px 1%;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save-coord {
            background: #4CAF50;
            color: white;
        }

        .btn-cancel-edit {
            background: #999;
            color: white;
        }

        .selected-line-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .selected-line-info strong {
            color: #1976d2;
        }

        .line-actions {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .line-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-delete-line {
            background: #f44336;
            color: white;
        }

        .btn-edit-line-info {
            background: #FF9800;
            color: white;
        }

        .line-info-edit-form {
            background: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 2px solid #ffc107;
        }

        .line-info-edit-form input,
        .line-info-edit-form select {
            width: 100%;
            padding: 5px;
            margin: 3px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 12px;
        }

        .line-info-edit-form label {
            font-size: 11px;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id='map'></div>

<div class="editor-panel">
    <h3>ğŸš† è·¯ç·šã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h3>
    
    <div id="input-section">
        <input type="text" id="line-name" placeholder="è·¯ç·šå (ä¾‹: å±±æ‰‹ç·š)">
        <input type="text" id="operator-name" placeholder="é‹å–¶ä¼šç¤¾ (ä¾‹: æ±æ—¥æœ¬æ—…å®¢é‰„é“)">
        
        <select id="operator-type">
            <option value="">äº‹æ¥­è€…åŒºåˆ†ã‚’é¸æŠ</option>
            <option value="1">JRæ–°å¹¹ç·š</option>
            <option value="2">JRåœ¨æ¥ç·š</option>
            <option value="3">å…¬å–¶é‰„é“</option>
            <option value="4">æ°‘å–¶é‰„é“</option>
            <option value="5">ç¬¬ä¸‰ã‚»ã‚¯ã‚¿ãƒ¼</option>
        </select>
        
        <select id="railway-type">
            <option value="">è·¯ç·šç¨®é¡ã‚’é¸æŠ</option>
            <option value="11">JR</option>
            <option value="12">æ™®é€šé‰„é“</option>
            <option value="21">è»Œé“</option>
            <option value="22">æ‡¸å‚å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
            <option value="23">è·¨åº§å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
        </select>
        
        <input type="color" id="line-color" value="#0066ff">
        <label for="line-color" style="font-size: 12px;">è·¯ç·šã‚«ãƒ©ãƒ¼</label>
    </div>
    
    <div class="info-text" id="status-text">
        è·¯ç·šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œæç”»é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
    </div>
    
    <div class="coordinates-count" id="coord-count">
        åº§æ¨™æ•°: 0
    </div>
    
    <button class="btn-start" id="btn-start" onclick="startDrawing()">
        ğŸ“ æç”»é–‹å§‹
    </button>
    
    <button class="btn-finish btn-disabled" id="btn-finish" onclick="finishDrawing()" disabled>
        âœ“ è·¯ç·šå®Œæˆ
    </button>
    
    <button class="btn-cancel btn-disabled" id="btn-cancel" onclick="cancelDrawing()" disabled>
        âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
    
    <div style="margin: 10px 0;">
        <label style="font-size: 12px; font-weight: bold;">ä¿å­˜å½¢å¼:</label>
        <select id="export-format" style="width: 100%; padding: 8px; margin: 5px 0;">
            <option value="geojson">GeoJSON (.json)</option>
            <option value="wkt-json">WKT JSON (.json)</option>
            <option value="wkt-text">WKT ãƒ†ã‚­ã‚¹ãƒˆ (.wkt)</option>
            <option value="csv">CSV (.csv)</option>
        </select>
    </div>

    <button class="btn-save" id="btn-save" onclick="saveToFile()">
        ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    </button>

    <input type="file" id="file-input" accept=".json,.wkt,.txt,.csv" style="display: none;" onchange="loadFile(event)">
    <button class="btn-save" id="btn-load" onclick="document.getElementById('file-input').click()">
        ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼
    </button>

    <button class="btn-edit-mode" id="btn-edit-mode" onclick="toggleEditMode()">
        âœï¸ åº§æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    </button>
</div>

<div class="coordinate-editor" id="coordinate-editor">
    <h3>ğŸ“ åº§æ¨™ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h3>

    <div id="selected-line-info" class="selected-line-info">
        è·¯ç·šã‚’é¸æŠã—ã¦ãã ã•ã„
    </div>

    <div id="line-info-edit-container"></div>

    <div class="line-actions" id="line-actions" style="display: none;">
        <button class="btn-edit-line-info" onclick="toggleLineInfoEdit()">
            ğŸ“ è·¯ç·šæƒ…å ±ç·¨é›†
        </button>
        <button class="btn-delete-line" onclick="deleteRailwayLine()">
            ğŸ—‘ï¸ è·¯ç·šå‰Šé™¤
        </button>
    </div>

    <div id="coord-list" class="coord-list"></div>

    <button class="btn-close-editor" onclick="closeCoordinateEditor()">
        é–‰ã˜ã‚‹
    </button>
</div>

<script>
// Mapbox ì•¡ì„¸ìŠ¤ í† í° ì„¤ì •
mapboxgl.accessToken = 'pk.eyJ1IjoibG9zdGNhZmUwIiwiYSI6ImNsMnBoOHpyMTAyMzczY254MmthZG1rOWEifQ.p_Xuk6AkxC7C9W4CPBwrjA';

// ì„ ë¡œ ìƒ‰ìƒ ë§¤í•‘
const lineColorMap = {
    "å°ç”°åŸç·š": "#0085CE",
    "æ±Ÿãƒå³¶ç·š": "#0085CE",
    "å¤šæ‘©ç·š": "#0085CE",
    "å¤šæ‘©ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«": "#286460",
    "ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒ³": "#0070C0",
    "ã‚°ãƒªãƒ¼ãƒ³ãƒ©ã‚¤ãƒ³": "#00B050",
    "ç§‹ç”°æ–°å¹¹ç·š": "#ED4399",
    "å·¦æ²¢ç·š": "#0073BF",
    "ç£è¶Šæ±ç·š": "#C71585",
    "ç£è¶Šè¥¿ç·š": "#CB7B35",
    "ä¸¸ãƒå†…ç·š": "#F62E36",
    "åƒä»£ç”°ç·š": "#00BB85",
    "å—åŒ—ç·š": "#00AC9B",
    "å‰¯éƒ½å¿ƒç·š": "#9C5E31",
    "éŠ€åº§ç·š": "#FF9500",
    "åŠè”µé–€ç·š": "#8F76D6",
    "æ—¥æ¯”è°·ç·š": "#B5B5AC",
    "æ±è¥¿ç·š": "#009BBF",
    "æœ‰æ¥½ç”ºç·š": "#C1A470",
    "ä¸¸ãƒå†…ç·šæ”¯ç·š": "#F62E36",
    "ä¸­å¤®ãƒ»ç·æ­¦å„é§…åœè»Š": "#FFE500",
    "ä¸­å¤®æœ¬ç·š": "#0071C5",
    "å¸¸ç£ç·š": "#0071C5",
    "å¾å¦»ç·š": "#008689",
    "ä¸­å¤®ç·šå¿«é€Ÿ": "#EB5C01",
    "å…«é«˜ç·š": "#A09D95",
    "ä¼Šæ±ç·š": "#FF9845",
    "å·è¶Šç·š(å·è¶Š-é«˜éº—å·é–“)": "#A6A9AB",
    "äº”æ—¥å¸‚ç·š": "#EB5C01",
    "å¸¸ç£ç·šå„é§…åœè»Š": "#9E9E9F",
    "å¸¸ç£ç·šå¿«é€Ÿ": "#00C18A",
    "ä¸Šè¶Šç·š": "#00ACD1",
    "é¹¿å³¶ç·š": "#A85F12",
    "äº¬æµœæ±åŒ—ç·šãƒ»æ ¹å²¸ç·š": "#00A7E3",
    "äº¬è‘‰ç·š": "#CF1225",
    "ä¹…ç•™é‡Œç·š": "#00C3A7",
    "æˆç”°ç·š": "#00BB85",
    "æ­¦è”µé‡ç·š": "#EB5C01",
    "å—æ­¦ç·šæµœå·å´æ”¯ç·š": "#FFE400",
    "å—æ­¦ç·š": "#FFE400",
    "æˆç”°ç·šæˆ‘å­«å­æ”¯ç·š": "#00BB85",
    "æˆç”°ç·šç©ºæ¸¯æ”¯ç·š": "#00BB85",
    "é’æ¢…ç·š": "#EB5C01",
    "ç›¸æ¨¡ç·š": "#008689",
    "åŸ¼äº¬ç·šãƒ»å·è¶Šç·š": "#00AC84",
    "æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³": "#DE0515",
    "ç·æ­¦å¿«é€Ÿç·š": "#0074BE",
    "ç·æ­¦æœ¬ç·š": "#FDD700",
    "ç›¸é‰„ç›´é€šç·š": "#00C3A7",
    "å¤–æˆ¿ç·š": "#F22335",
    "é«˜å´ç·š": "#FF9845",
    "æ±é‡‘ç·š": "#B31C31",
    "æ±æµ·é“ç·š": "#FF9845",
    "é¶´è¦‹ç·šå¤§å·æ”¯ç·š": "#FFE500",
    "é¶´è¦‹ç·šæµ·èŠæµ¦æ”¯ç·š": "#FFE500",
    "é¶´è¦‹ç·š": "#FFE500",
    "å†…æˆ¿ç·š": "#0071C5",
    "å®‡éƒ½å®®ç·š": "#FF9845",
    "å±±æ‰‹ç·š": "#85C023",
    "æ¨ªæµœç·š": "#85C023",
    "æ¨ªé ˆè³€ç·š": "#0074BE",
    "æµ…è‰ç·š": "#FF535F",
    "ä¸‰ç”°ç·š": "#0067B0",
    "å¤§æ±Ÿæˆ¸ç·š": "#CF3366",
    "æ–°å®¿ç·š": "#9FB01C",
    "æ—¥å…‰ç·š": "#F5A302",
    "æ±æ­¦ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ãƒ©ã‚¤ãƒ³": "#226BB8",
    "å¤§å¸«ç·š": "#226BB8",
    "ä¼Šå‹¢å´ç·š": "#E62119",
    "æ¡ç”Ÿç·š": "#E62119",
    "äº€æˆ¸ç·š": "#226BB8",
    "é¬¼æ€’å·ç·š": "#F5A302",
    "ã‚†ã‚Šã‹ã‚‚ã‚": "#0065A6",
    "å°æ³‰ç·š(æ±å°æ³‰-å¤ªç”°)": "#E62119",
    "å°æ³‰ç·š": "#E62119",
    "è¶Šç”Ÿç·š": "#10428B",
    "ä½é‡ç·š": "#E62119",
    "æ±æ­¦ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ãƒ©ã‚¤ãƒ³(æŠ¼ä¸Š-æ›³èˆŸ)": "#226BB8",
    "æ±æ­¦ã‚¢ãƒ¼ãƒãƒ³ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³": "#41B3E5",
    "æ±ä¸Šç·š": "#10428B",
    "å®‡éƒ½å®®ç·š": "#F5A302",
    "äº¬æ€¥æœ¬ç·š": "#0DB0E9",
    "ç©ºæ¸¯ç·š": "#0DB0E9",
    "å¤§å¸«ç·š": "#0DB0E9",
    "ä¹…é‡Œæµœç·š": "#0DB0E9",
    "é€—å­ç·š": "#0DB0E9",
    "ã‚Šã‚“ã‹ã„ç·š": "#222D65",
    "æ±æ€¥å¤šæ‘©å·ç·š": "#AE0379",
    "æ±æ¨ªç·š": "#DB0442",
    "è±Šå³¶ç·š": "#FF710A",
    "ã„ãšã¿é‡ç·š": "#0073BC",
    "ç›¸é‰„æœ¬ç·š": "#0073BC",
    "ç›¸é‰„æ–°æ¨ªæµœç·š": "#0073BC",
    "æ‹å³¶ç·š": "#00A8B5",
    "æ± è¢‹ç·š": "#FF710A",
    "å›½åˆ†å¯ºç·š": "#00A943",
    "ç‹­å±±ç·š": "#FF710A",
    "è¥¿æ­¦ç§©çˆ¶ç·š": "#FF710A",
    "è¥¿æ­¦æœ‰æ¥½ç”ºç·š": "#FF710A",
    "è¥¿æ­¦åœ’ç·š": "#00A943",
    "æ–°å®¿ç·š": "#00A8B5",
    "å¤šæ‘©å·ç·š": "#FF710A",
    "ç”°åœ’éƒ½å¸‚ç·š": "#00AA8E",
    "æ± ä¸Šç·š": "#EE86A7",
    "ä¸–ç”°è°·ç·š": "#FCC80D",
    "ã“ã©ã‚‚ã®å›½ç·š": "#0071BE",
    "ç›®é»’ç·š": "#009CD3",
    "å¤§äº•ç”ºç·š": "#F18C43",
    "æ±æ€¥æ–°æ¨ªæµœç·š": "#890D84",
    "å¤šæ‘©æ¹–ç·š": "#FFA600",
    "å±±å£ç·š": "#FF565D"
};

// ì‚¬ì—…ì êµ¬ë¶„ ì½”ë“œ ë§¤í•‘
const operatorTypeMap = {
    "1": "JRæ–°å¹¹ç·š", 
    "2": "JRåœ¨æ¥ç·š", 
    "3": "å…¬å–¶é‰„é“", 
    "4": "æ°‘å–¶é‰„é“", 
    "5": "ç¬¬ä¸‰ã‚»ã‚¯ã‚¿ãƒ¼" 
};

// ë…¸ì„  ì¢…ë¥˜ êµ¬ë¶„ ì½”ë“œ ë§¤í•‘
const railwayTypeMap = { 
    "11": "JR", 
    "12": "æ™®é€šé‰„é“", 
    "13": "é‹¼ç´¢é‰„é“", 
    "14": "æ‡¸å‚å¼é‰„é“", 
    "15": "è·¨åº§å¼é‰„é“", 
    "16": "æ¡ˆå†…è»Œæ¡å¼é‰„é“", 
    "17": "ç„¡è»Œæ¡é‰„é“", 
    "21": "è»Œé“", 
    "22": "æ‡¸å‚å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«", 
    "23": "è·¨åº§å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«", 
    "24": "æ¡ˆå†…è»Œæ¡å¼", 
    "25": "æµ®ä¸Šå¼" 
};

// í¸ì§‘ ìƒíƒœ ê´€ë¦¬
let isDrawing = false;
let currentCoordinates = [];
let rawData = []; // ì›ë³¸ ë°ì´í„° ì €ì¥
let geojsonData = null; // ë³€í™˜ëœ GeoJSON ë°ì´í„°
let isEditMode = false; // ì¢Œí‘œ í¸ì§‘ ëª¨ë“œ
let selectedLineIndex = null; // ì„ íƒëœ ì„ ë¡œ ì¸ë±ìŠ¤
let selectedMultiLineIndex = 0; // MultiLineString ë‚´ ì„ íƒëœ ë¼ì¸ ì¸ë±ìŠ¤
let editingCoordIndex = null; // í¸ì§‘ ì¤‘ì¸ ì¢Œí‘œ ì¸ë±ìŠ¤

// ========== WKT ë³€í™˜ ìœ í‹¸ë¦¬í‹° ==========

// GeoJSON ì¢Œí‘œë¥¼ WKT ì¢Œí‘œ ë¬¸ìì—´ë¡œ ë³€í™˜ (ê²½ë„ ìœ„ë„ ìˆœì„œ)
function coordsToWKT(coords) {
    return coords.map(c => `${c[0]} ${c[1]}`).join(', ');
}

// WKT ì¢Œí‘œ ë¬¸ìì—´ì„ GeoJSON ì¢Œí‘œë¡œ ë³€í™˜
function wktToCoords(wktCoords) {
    return wktCoords.trim().split(',').map(pair => {
        const [lng, lat] = pair.trim().split(/\s+/).map(Number);
        return [lng, lat];
    });
}

// LineStringì„ WKTë¡œ ë³€í™˜
function lineStringToWKT(coordinates) {
    return `LINESTRING(${coordsToWKT(coordinates)})`;
}

// MultiLineStringì„ WKTë¡œ ë³€í™˜
function multiLineStringToWKT(coordinates) {
    const lines = coordinates.map(line => `(${coordsToWKT(line)})`).join(', ');
    return `MULTILINESTRING(${lines})`;
}

// WKT LINESTRING íŒŒì‹±
function parseWKTLineString(wkt) {
    const match = wkt.match(/LINESTRING\s*\(([^)]+)\)/i);
    if (!match) return null;
    return wktToCoords(match[1]);
}

// WKT MULTILINESTRING íŒŒì‹±
function parseWKTMultiLineString(wkt) {
    const match = wkt.match(/MULTILINESTRING\s*\((.+)\)/i);
    if (!match) return null;

    const content = match[1];
    const lines = [];
    let depth = 0;
    let current = '';

    for (let i = 0; i < content.length; i++) {
        const char = content[i];
        if (char === '(') depth++;
        else if (char === ')') depth--;

        if (depth === 0 && char === ',') {
            lines.push(wktToCoords(current));
            current = '';
        } else if (char !== '(' && char !== ')') {
            current += char;
        }
    }
    if (current.trim()) {
        lines.push(wktToCoords(current));
    }

    return lines;
}

// WKT ë¬¸ìì—´ íŒŒì‹± (LINESTRING ë˜ëŠ” MULTILINESTRING)
function parseWKT(wkt) {
    wkt = wkt.trim();
    if (wkt.startsWith('MULTILINESTRING')) {
        return parseWKTMultiLineString(wkt);
    } else if (wkt.startsWith('LINESTRING')) {
        return [parseWKTLineString(wkt)];
    }
    return null;
}

// ì „ì²´ ë°ì´í„°ë¥¼ WKT í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function convertDataToWKT(data) {
    return data.map(railway => {
        const coords = normalizeCoordinates(railway.coordinates);
        const wkt = coords.length === 1 ? lineStringToWKT(coords[0]) : multiLineStringToWKT(coords);

        return {
            label: railway.label,
            N02_004: railway.N02_004,
            N02_002: railway.N02_002,
            N02_001: railway.N02_001,
            geometry: wkt
        };
    });
}

// WKT ë°ì´í„°ë¥¼ ë‚´ë¶€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function convertWKTToData(wktData) {
    return wktData.map(item => {
        const coords = parseWKT(item.geometry);
        return {
            label: item.label,
            N02_004: item.N02_004,
            N02_002: item.N02_002,
            N02_001: item.N02_001,
            coordinates: coords.length === 1 ? coords[0] : coords
        };
    });
}

// ìˆœìˆ˜ WKT í…ìŠ¤íŠ¸ íŒŒì¼ íŒŒì‹± (í•œ ì¤„ì— í•˜ë‚˜ì˜ WKT)
function parseWKTTextFile(text) {
    const lines = text.trim().split('\n').filter(line => line.trim());
    const data = [];

    lines.forEach((line, index) => {
        line = line.trim();
        if (line.startsWith('LINESTRING') || line.startsWith('MULTILINESTRING')) {
            const coords = parseWKT(line);
            if (coords) {
                data.push({
                    label: `è·¯ç·š${index + 1}`,
                    N02_004: 'ä¸æ˜',
                    N02_002: '4',
                    N02_001: '12',
                    coordinates: coords.length === 1 ? coords[0] : coords
                });
            }
        }
    });

    return data;
}

// CSV íŒŒì¼ íŒŒì‹± (WKT ì»¬ëŸ¼ í¬í•¨)
function parseCSVFile(text) {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];

    // í—¤ë” íŒŒì‹±
    const headers = lines[0].split(',').map(h => h.trim());
    const labelIdx = headers.findIndex(h => h.match(/label|name|è·¯ç·šå/i));
    const operatorIdx = headers.findIndex(h => h.match(/operator|company|é‹å–¶ä¼šç¤¾|N02_004/i));
    const operatorTypeIdx = headers.findIndex(h => h.match(/operatorType|äº‹æ¥­è€…åŒºåˆ†|N02_002/i));
    const railwayTypeIdx = headers.findIndex(h => h.match(/railwayType|è·¯ç·šç¨®é¡|N02_001/i));
    const wktIdx = headers.findIndex(h => h.match(/wkt|geometry|geom/i));

    if (wktIdx === -1) {
        throw new Error('CSV file must contain a WKT/geometry column');
    }

    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const cols = parseCSVLine(line);
        const wktString = cols[wktIdx];

        if (wktString && (wktString.startsWith('LINESTRING') || wktString.startsWith('MULTILINESTRING'))) {
            const coords = parseWKT(wktString);
            if (coords) {
                data.push({
                    label: labelIdx !== -1 ? cols[labelIdx] : `è·¯ç·š${i}`,
                    N02_004: operatorIdx !== -1 ? cols[operatorIdx] : 'ä¸æ˜',
                    N02_002: operatorTypeIdx !== -1 ? cols[operatorTypeIdx] : '4',
                    N02_001: railwayTypeIdx !== -1 ? cols[railwayTypeIdx] : '12',
                    coordinates: coords.length === 1 ? coords[0] : coords
                });
            }
        }
    }

    return data;
}

// CSV ë¼ì¸ íŒŒì‹± (ì‰¼í‘œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }

    result.push(current.trim());
    return result;
}

// ë°ì´í„°ë¥¼ ìˆœìˆ˜ WKT í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
function convertDataToWKTText(data) {
    return data.map(railway => {
        const coords = normalizeCoordinates(railway.coordinates);
        const wkt = coords.length === 1 ? lineStringToWKT(coords[0]) : multiLineStringToWKT(coords);
        return `# ${railway.label} (${railway.N02_004})\n${wkt}`;
    }).join('\n\n');
}

// ë°ì´í„°ë¥¼ CSVë¡œ ë³€í™˜
function convertDataToCSV(data) {
    let csv = 'label,operator,operatorType,railwayType,geometry\n';

    data.forEach(railway => {
        const coords = normalizeCoordinates(railway.coordinates);
        const wkt = coords.length === 1 ? lineStringToWKT(coords[0]) : multiLineStringToWKT(coords);

        const label = railway.label.includes(',') ? `"${railway.label}"` : railway.label;
        const operator = railway.N02_004.includes(',') ? `"${railway.N02_004}"` : railway.N02_004;

        csv += `${label},${operator},${railway.N02_002},${railway.N02_001},"${wkt}"\n`;
    });

    return csv;
}

// ìƒ‰ìƒ ì°¾ê¸° í•¨ìˆ˜
function getLineColor(label) {
    if (lineColorMap[label]) {
        return lineColorMap[label];
    }
    if (label.startsWith('JR')) {
        const labelWithoutJR = label.substring(2);
        if (lineColorMap[labelWithoutJR]) {
            return lineColorMap[labelWithoutJR];
        }
    }
    return '#0066ff';
}

// ì¢Œí‘œ ì •ê·œí™” í•¨ìˆ˜
function normalizeCoordinates(coords) {
    if (Array.isArray(coords[0]) && Array.isArray(coords[0][0])) {
        return coords;
    } else {
        return [coords];
    }
}

// GeoJSON íŒŒì¼ ë¡œë“œ ë° ë³€í™˜
async function loadAndConvertGeoJSON(url) {
    const response = await fetch(url);
    const data = await response.json();
    rawData = data; // ì›ë³¸ ë°ì´í„° ì €ì¥
    
    return {
        'type': 'FeatureCollection',
        'features': data.map(railway => ({
            'type': 'Feature',
            'properties': {
                'label': railway.label,
                'operator': railway.N02_004,
                'operatorType': railway.N02_002,
                'railwayType': railway.N02_001,
                'color': getLineColor(railway.label)
            },
            'geometry': {
                'type': 'MultiLineString',
                'coordinates': normalizeCoordinates(railway.coordinates)
            }
        }))
    };
}

// ë§µ ì´ˆê¸°í™”
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/lostcafe0/cmgyogzdq007201r59ni6b9fd',
    center: [135, 35],
    zoom: 5
});

// ê·¸ë¦¬ê¸° ì‹œì‘
function startDrawing() {
    const lineName = document.getElementById('line-name').value;
    const operatorName = document.getElementById('operator-name').value;
    const operatorType = document.getElementById('operator-type').value;
    const railwayType = document.getElementById('railway-type').value;
    
    if (!lineName || !operatorName || !operatorType || !railwayType) {
        alert('ã™ã¹ã¦ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    isDrawing = true;
    currentCoordinates = [];
    
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-start').classList.add('btn-disabled');
    document.getElementById('btn-finish').disabled = false;
    document.getElementById('btn-finish').classList.remove('btn-disabled');
    document.getElementById('btn-cancel').disabled = false;
    document.getElementById('btn-cancel').classList.remove('btn-disabled');
    document.getElementById('input-section').style.opacity = '0.5';
    document.getElementById('status-text').textContent = 'åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åº§æ¨™ã‚’è¿½åŠ ';
    
    map.getCanvas().style.cursor = 'crosshair';
}

// ê·¸ë¦¬ê¸° ì™„ë£Œ
function finishDrawing() {
    if (currentCoordinates.length < 2) {
        alert('æœ€ä½2ã¤ã®åº§æ¨™ãŒå¿…è¦ã§ã™');
        return;
    }
    
    const lineName = document.getElementById('line-name').value;
    const operatorName = document.getElementById('operator-name').value;
    const operatorType = document.getElementById('operator-type').value;
    const railwayType = document.getElementById('railway-type').value;
    const lineColor = document.getElementById('line-color').value;
    
    // ì›ë³¸ ë°ì´í„°ì— ì¶”ê°€
    const newRailway = {
        label: lineName,
        N02_004: operatorName,
        N02_002: operatorType,
        N02_001: railwayType,
        coordinates: currentCoordinates
    };
    
    rawData.push(newRailway);
    
    // GeoJSONì— ì¶”ê°€
    const newFeature = {
        'type': 'Feature',
        'properties': {
            'label': lineName,
            'operator': operatorName,
            'operatorType': operatorType,
            'railwayType': railwayType,
            'color': lineColor
        },
        'geometry': {
            'type': 'MultiLineString',
            'coordinates': [currentCoordinates]
        }
    };
    
    geojsonData.features.push(newFeature);
    
    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);
    
    // ìƒíƒœ ë¦¬ì…‹
    resetDrawing();
    
    alert(`è·¯ç·šã€Œ${lineName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nåº§æ¨™æ•°: ${currentCoordinates.length}`);
}

// ê·¸ë¦¬ê¸° ì·¨ì†Œ
function cancelDrawing() {
    if (currentCoordinates.length > 0) {
        if (!confirm('æç”»ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }
    }
    
    // ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
    
    resetDrawing();
}

// ìƒíƒœ ë¦¬ì…‹
function resetDrawing() {
    isDrawing = false;
    currentCoordinates = [];
    
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').classList.remove('btn-disabled');
    document.getElementById('btn-finish').disabled = true;
    document.getElementById('btn-finish').classList.add('btn-disabled');
    document.getElementById('btn-cancel').disabled = true;
    document.getElementById('btn-cancel').classList.add('btn-disabled');
    document.getElementById('input-section').style.opacity = '1';
    document.getElementById('status-text').textContent = 'è·¯ç·šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œæç”»é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
    document.getElementById('coord-count').textContent = 'åº§æ¨™æ•°: 0';
    
    map.getCanvas().style.cursor = '';
    
    // ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
}

// íŒŒì¼ë¡œ ì €ì¥
function saveToFile() {
    if (rawData.length === 0) {
        alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    const format = document.getElementById('export-format').value;
    let dataStr, fileName, mimeType;

    switch (format) {
        case 'wkt-json':
            // WKT JSON í˜•ì‹
            const wktData = convertDataToWKT(rawData);
            dataStr = JSON.stringify(wktData, null, 2);
            fileName = 'railway_data_wkt.json';
            mimeType = 'application/json';
            break;

        case 'wkt-text':
            // ìˆœìˆ˜ WKT í…ìŠ¤íŠ¸
            dataStr = convertDataToWKTText(rawData);
            fileName = 'railway_data.wkt';
            mimeType = 'text/plain';
            break;

        case 'csv':
            // CSV í˜•ì‹
            dataStr = convertDataToCSV(rawData);
            fileName = 'railway_data.csv';
            mimeType = 'text/csv';
            break;

        default:
            // GeoJSON í˜•ì‹ (ê¸°ë³¸)
            dataStr = JSON.stringify(rawData, null, 2);
            fileName = 'railway_data_geojson.json';
            mimeType = 'application/json';
    }

    const blob = new Blob([dataStr], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(url);

    alert(`${fileName} ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
}

// íŒŒì¼ ë¡œë“œ
async function loadFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        const text = await file.text();
        const fileName = file.name.toLowerCase();
        let loadedData = null;
        let formatName = '';

        // íŒŒì¼ í˜•ì‹ ê°ì§€
        if (fileName.endsWith('.csv')) {
            // CSV íŒŒì¼
            loadedData = parseCSVFile(text);
            formatName = 'CSV';
        } else if (fileName.endsWith('.wkt') || fileName.endsWith('.txt')) {
            // ìˆœìˆ˜ WKT í…ìŠ¤íŠ¸ íŒŒì¼
            loadedData = parseWKTTextFile(text);
            formatName = 'WKT ãƒ†ã‚­ã‚¹ãƒˆ';
        } else if (fileName.endsWith('.json')) {
            // JSON íŒŒì¼ (WKT JSON ë˜ëŠ” GeoJSON)
            const data = JSON.parse(text);

            if (data.length > 0 && data[0].geometry && typeof data[0].geometry === 'string') {
                // WKT JSON í˜•ì‹
                loadedData = convertWKTToData(data);
                formatName = 'WKT JSON';
            } else if (data.length > 0 && data[0].coordinates) {
                // GeoJSON í˜•ì‹
                loadedData = data;
                formatName = 'GeoJSON';
            } else {
                alert('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„JSONå½¢å¼ã§ã™');
                return;
            }
        } else {
            alert('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™\\n(.json, .wkt, .txt, .csv ã‚’ã‚µãƒãƒ¼ãƒˆ)');
            return;
        }

        if (!loadedData || loadedData.length === 0) {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            return;
        }

        rawData = loadedData;

        // GeoJSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì§€ë„ ì—…ë°ì´íŠ¸
        geojsonData = {
            'type': 'FeatureCollection',
            'features': rawData.map(railway => ({
                'type': 'Feature',
                'properties': {
                    'label': railway.label,
                    'operator': railway.N02_004,
                    'operatorType': railway.N02_002,
                    'railwayType': railway.N02_001,
                    'color': getLineColor(railway.label)
                },
                'geometry': {
                    'type': 'MultiLineString',
                    'coordinates': normalizeCoordinates(railway.coordinates)
                }
            }))
        };

        // ì§€ë„ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
        if (map.getSource('railways')) {
            map.getSource('railways').setData(geojsonData);

            // ì „ì²´ ë…¸ì„ ì´ ë³´ì´ë„ë¡ ë§µ ì¡°ì •
            const bounds = new mapboxgl.LngLatBounds();
            geojsonData.features.forEach(feature => {
                feature.geometry.coordinates.forEach(line => {
                    line.forEach(coord => {
                        bounds.extend(coord);
                    });
                });
            });
            map.fitBounds(bounds, { padding: 50 });
        }

        alert(formatName + ' å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\\nè·¯ç·šæ•°: ' + rawData.length);

        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        event.target.value = '';

    } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ\\n' + error.message);
    }
}

// í¸ì§‘ ëª¨ë“œ í† ê¸€
function toggleEditMode() {
    if (isDrawing) {
        alert('æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¦ãã ã•ã„');
        return;
    }

    isEditMode = !isEditMode;

    if (isEditMode) {
        document.getElementById('btn-edit-mode').textContent = 'ğŸ”™ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹';
        document.getElementById('btn-edit-mode').style.background = '#FF5722';
        document.getElementById('coordinate-editor').classList.add('active');
        document.getElementById('status-text').textContent = 'åœ°å›³ä¸Šã®è·¯ç·šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ';
        map.getCanvas().style.cursor = 'pointer';
    } else {
        document.getElementById('btn-edit-mode').textContent = 'âœï¸ åº§æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
        document.getElementById('btn-edit-mode').style.background = '#9C27B0';
        closeCoordinateEditor();
    }
}

// ì¢Œí‘œ ì—ë””í„° ë‹«ê¸°
function closeCoordinateEditor() {
    isEditMode = false;
    selectedLineIndex = null;
    selectedMultiLineIndex = 0;
    editingCoordIndex = null;
    document.getElementById('coordinate-editor').classList.remove('active');
    document.getElementById('btn-edit-mode').textContent = 'âœï¸ åº§æ¨™ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
    document.getElementById('btn-edit-mode').style.background = '#9C27B0';
    document.getElementById('status-text').textContent = 'è·¯ç·šæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œæç”»é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
    document.getElementById('line-actions').style.display = 'none';
    document.getElementById('line-info-edit-container').innerHTML = '';
    map.getCanvas().style.cursor = '';
}

// ë¼ì¸(ì„ ë¡œ) ì „ì²´ ì‚­ì œ
function deleteRailwayLine() {
    if (selectedLineIndex === null) {
        alert('è·¯ç·šãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }

    const railway = rawData[selectedLineIndex];
    const lineName = railway.label;

    if (!confirm(`è·¯ç·šã€Œ${lineName}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }

    // rawDataì—ì„œ ì‚­ì œ
    rawData.splice(selectedLineIndex, 1);

    // geojsonDataì—ì„œ ì‚­ì œ
    geojsonData.features.splice(selectedLineIndex, 1);

    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);

    alert(`è·¯ç·šã€Œ${lineName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼`);

    // ì—ë””í„° ë‹«ê¸°
    closeCoordinateEditor();
}

// ë¼ì¸ ì •ë³´ í¸ì§‘ í† ê¸€
let isEditingLineInfo = false;

function toggleLineInfoEdit() {
    if (selectedLineIndex === null) return;

    isEditingLineInfo = !isEditingLineInfo;
    const container = document.getElementById('line-info-edit-container');

    if (isEditingLineInfo) {
        const railway = rawData[selectedLineIndex];

        container.innerHTML = `
            <div class="line-info-edit-form">
                <label>è·¯ç·šå</label>
                <input type="text" id="edit-line-name" value="${railway.label}">

                <label>é‹å–¶ä¼šç¤¾</label>
                <input type="text" id="edit-line-operator" value="${railway.N02_004}">

                <label>äº‹æ¥­è€…åŒºåˆ†</label>
                <select id="edit-line-operator-type">
                    <option value="1" ${railway.N02_002 === '1' ? 'selected' : ''}>JRæ–°å¹¹ç·š</option>
                    <option value="2" ${railway.N02_002 === '2' ? 'selected' : ''}>JRåœ¨æ¥ç·š</option>
                    <option value="3" ${railway.N02_002 === '3' ? 'selected' : ''}>å…¬å–¶é‰„é“</option>
                    <option value="4" ${railway.N02_002 === '4' ? 'selected' : ''}>æ°‘å–¶é‰„é“</option>
                    <option value="5" ${railway.N02_002 === '5' ? 'selected' : ''}>ç¬¬ä¸‰ã‚»ã‚¯ã‚¿ãƒ¼</option>
                </select>

                <label>è·¯ç·šç¨®é¡</label>
                <select id="edit-line-railway-type">
                    <option value="11" ${railway.N02_001 === '11' ? 'selected' : ''}>JR</option>
                    <option value="12" ${railway.N02_001 === '12' ? 'selected' : ''}>æ™®é€šé‰„é“</option>
                    <option value="21" ${railway.N02_001 === '21' ? 'selected' : ''}>è»Œé“</option>
                    <option value="22" ${railway.N02_001 === '22' ? 'selected' : ''}>æ‡¸å‚å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
                    <option value="23" ${railway.N02_001 === '23' ? 'selected' : ''}>è·¨åº§å¼ãƒ¢ãƒãƒ¬ãƒ¼ãƒ«</option>
                </select>

                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="btn-save-coord" style="flex: 1;" onclick="saveLineInfoEdit()">ä¿å­˜</button>
                    <button class="btn-cancel-edit" style="flex: 1;" onclick="cancelLineInfoEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = '';
    }
}

// ë¼ì¸ ì •ë³´ í¸ì§‘ ì €ì¥
function saveLineInfoEdit() {
    if (selectedLineIndex === null) return;

    const newLabel = document.getElementById('edit-line-name').value.trim();
    const newOperator = document.getElementById('edit-line-operator').value.trim();
    const newOperatorType = document.getElementById('edit-line-operator-type').value;
    const newRailwayType = document.getElementById('edit-line-railway-type').value;

    if (!newLabel || !newOperator) {
        alert('è·¯ç·šåã¨é‹å–¶ä¼šç¤¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    // rawData ì—…ë°ì´íŠ¸
    rawData[selectedLineIndex].label = newLabel;
    rawData[selectedLineIndex].N02_004 = newOperator;
    rawData[selectedLineIndex].N02_002 = newOperatorType;
    rawData[selectedLineIndex].N02_001 = newRailwayType;

    // GeoJSON ì—…ë°ì´íŠ¸
    geojsonData.features[selectedLineIndex].properties.label = newLabel;
    geojsonData.features[selectedLineIndex].properties.operator = newOperator;
    geojsonData.features[selectedLineIndex].properties.operatorType = newOperatorType;
    geojsonData.features[selectedLineIndex].properties.railwayType = newRailwayType;
    geojsonData.features[selectedLineIndex].properties.color = getLineColor(newLabel);

    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);

    // ì„ ë¡œ ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
    const operatorTypeName = operatorTypeMap[newOperatorType] || newOperatorType;
    const railwayTypeName = railwayTypeMap[newRailwayType] || newRailwayType;
    const railway = rawData[selectedLineIndex];
    const multiLineCoords = normalizeCoordinates(railway.coordinates);

    document.getElementById('selected-line-info').innerHTML = `
        <strong>${newLabel}</strong><br>
        é‹å–¶ä¼šç¤¾: ${newOperator}<br>
        äº‹æ¥­è€…åŒºåˆ†: ${operatorTypeName}<br>
        è·¯ç·šç¨®é¡: ${railwayTypeName}<br>
        <small style="color: #666;">ãƒ©ã‚¤ãƒ³ ${selectedMultiLineIndex + 1}/${multiLineCoords.length}</small>
    `;

    // í¸ì§‘ í¼ ë‹«ê¸°
    isEditingLineInfo = false;
    document.getElementById('line-info-edit-container').innerHTML = '';

    alert('è·¯ç·šæƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
}

// ë¼ì¸ ì •ë³´ í¸ì§‘ ì·¨ì†Œ
function cancelLineInfoEdit() {
    isEditingLineInfo = false;
    document.getElementById('line-info-edit-container').innerHTML = '';
}

// ì„ ë¡œ ì„ íƒí•˜ì—¬ í¸ì§‘
function selectLineForEditing(featureIndex, clickedCoords) {
    selectedLineIndex = featureIndex;
    const feature = geojsonData.features[featureIndex];
    const railway = rawData[featureIndex];

    // MultiLineStringì˜ ì–´ëŠ ë¼ì¸ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ ì°¾ê¸°
    const multiLineCoords = normalizeCoordinates(railway.coordinates);
    let closestLineIndex = 0;
    let minDistance = Infinity;

    multiLineCoords.forEach((lineCoords, lineIndex) => {
        lineCoords.forEach(coord => {
            const distance = Math.sqrt(
                Math.pow(coord[0] - clickedCoords[0], 2) +
                Math.pow(coord[1] - clickedCoords[1], 2)
            );
            if (distance < minDistance) {
                minDistance = distance;
                closestLineIndex = lineIndex;
            }
        });
    });

    selectedMultiLineIndex = closestLineIndex;

    // ì„ ë¡œ ì •ë³´ í‘œì‹œ
    const operatorTypeName = operatorTypeMap[railway.N02_002] || railway.N02_002;
    const railwayTypeName = railwayTypeMap[railway.N02_001] || railway.N02_001;

    document.getElementById('selected-line-info').innerHTML = `
        <strong>${railway.label}</strong><br>
        é‹å–¶ä¼šç¤¾: ${railway.N02_004}<br>
        äº‹æ¥­è€…åŒºåˆ†: ${operatorTypeName}<br>
        è·¯ç·šç¨®é¡: ${railwayTypeName}<br>
        <small style="color: #666;">ãƒ©ã‚¤ãƒ³ ${closestLineIndex + 1}/${multiLineCoords.length}</small>
    `;

    // ë¼ì¸ ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
    document.getElementById('line-actions').style.display = 'flex';

    // ì¢Œí‘œ ëª©ë¡ í‘œì‹œ
    displayCoordinates();
}

// ì¢Œí‘œ ëª©ë¡ í‘œì‹œ
function displayCoordinates() {
    const railway = rawData[selectedLineIndex];
    const multiLineCoords = normalizeCoordinates(railway.coordinates);
    const coordinates = multiLineCoords[selectedMultiLineIndex];

    const coordListDiv = document.getElementById('coord-list');
    coordListDiv.innerHTML = '';

    coordinates.forEach((coord, index) => {
        const coordItem = document.createElement('div');
        coordItem.className = 'coord-item';
        coordItem.id = `coord-item-${index}`;

        coordItem.innerHTML = `
            <div class="coord-info">
                <strong>#${index + 1}</strong><br>
                çµŒåº¦: ${coord[0].toFixed(6)}<br>
                ç·¯åº¦: ${coord[1].toFixed(6)}
            </div>
            <div class="coord-actions">
                <button class="btn-edit-coord" onclick="editCoordinate(${index})">ç·¨é›†</button>
                <button class="btn-delete-coord" onclick="deleteCoordinate(${index})">å‰Šé™¤</button>
            </div>
        `;

        coordListDiv.appendChild(coordItem);
    });
}

// ì¢Œí‘œ í¸ì§‘
function editCoordinate(index) {
    editingCoordIndex = index;
    const railway = rawData[selectedLineIndex];
    const multiLineCoords = normalizeCoordinates(railway.coordinates);
    const coord = multiLineCoords[selectedMultiLineIndex][index];

    const coordItem = document.getElementById(`coord-item-${index}`);
    coordItem.innerHTML = `
        <div class="edit-form">
            <label style="font-size: 12px; font-weight: bold;">åº§æ¨™ #${index + 1} ã‚’ç·¨é›†</label>
            <input type="number" id="edit-lng" step="0.000001" value="${coord[0]}" placeholder="çµŒåº¦">
            <input type="number" id="edit-lat" step="0.000001" value="${coord[1]}" placeholder="ç·¯åº¦">
            <div>
                <button class="btn-save-coord" onclick="saveCoordinateEdit(${index})">ä¿å­˜</button>
                <button class="btn-cancel-edit" onclick="cancelCoordinateEdit(${index})">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    `;
}

// ì¢Œí‘œ í¸ì§‘ ì €ì¥
function saveCoordinateEdit(index) {
    const lng = parseFloat(document.getElementById('edit-lng').value);
    const lat = parseFloat(document.getElementById('edit-lat').value);

    if (isNaN(lng) || isNaN(lat)) {
        alert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    // rawData ì—…ë°ì´íŠ¸
    const railway = rawData[selectedLineIndex];
    const multiLineCoords = normalizeCoordinates(railway.coordinates);
    multiLineCoords[selectedMultiLineIndex][index] = [lng, lat];

    // ì •ê·œí™”ëœ ì¢Œí‘œë¥¼ ë‹¤ì‹œ ì €ì¥
    if (Array.isArray(railway.coordinates[0]) && Array.isArray(railway.coordinates[0][0])) {
        railway.coordinates = multiLineCoords;
    } else {
        railway.coordinates = multiLineCoords[0];
    }

    // GeoJSON ì—…ë°ì´íŠ¸
    geojsonData.features[selectedLineIndex].geometry.coordinates = multiLineCoords;

    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);

    // í‘œì‹œ ì—…ë°ì´íŠ¸
    editingCoordIndex = null;
    displayCoordinates();

    alert('åº§æ¨™ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
}

// ì¢Œí‘œ í¸ì§‘ ì·¨ì†Œ
function cancelCoordinateEdit(index) {
    editingCoordIndex = null;
    displayCoordinates();
}

// ì¢Œí‘œ ì‚­ì œ
function deleteCoordinate(index) {
    const railway = rawData[selectedLineIndex];
    const multiLineCoords = normalizeCoordinates(railway.coordinates);
    const coordinates = multiLineCoords[selectedMultiLineIndex];

    if (coordinates.length <= 2) {
        alert('è·¯ç·šã«ã¯æœ€ä½2ã¤ã®åº§æ¨™ãŒå¿…è¦ã§ã™');
        return;
    }

    if (!confirm(`åº§æ¨™ #${index + 1} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    // ì¢Œí‘œ ì‚­ì œ
    coordinates.splice(index, 1);

    // rawData ì—…ë°ì´íŠ¸
    if (Array.isArray(railway.coordinates[0]) && Array.isArray(railway.coordinates[0][0])) {
        railway.coordinates = multiLineCoords;
    } else {
        railway.coordinates = multiLineCoords[0];
    }

    // GeoJSON ì—…ë°ì´íŠ¸
    geojsonData.features[selectedLineIndex].geometry.coordinates = multiLineCoords;

    // ì§€ë„ ì—…ë°ì´íŠ¸
    map.getSource('railways').setData(geojsonData);

    // í‘œì‹œ ì—…ë°ì´íŠ¸
    displayCoordinates();

    alert('åº§æ¨™ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼');
}

// ì„ì‹œ ì„  ì—…ë°ì´íŠ¸
function updateTempLine() {
    if (currentCoordinates.length === 0) return;
    
    const lineColor = document.getElementById('line-color').value;
    
    // ê¸°ì¡´ ì„ì‹œ ë ˆì´ì–´ ì œê±°
    if (map.getLayer('temp-line')) {
        map.removeLayer('temp-line');
        map.removeSource('temp-line');
    }
    if (map.getLayer('temp-points')) {
        map.removeLayer('temp-points');
        map.removeSource('temp-points');
    }
    
    // ì„ì‹œ ì„  ì¶”ê°€
    map.addSource('temp-line', {
        'type': 'geojson',
        'data': {
            'type': 'Feature',
            'geometry': {
                'type': 'LineString',
                'coordinates': currentCoordinates
            }
        }
    });
    
    map.addLayer({
        'id': 'temp-line',
        'type': 'line',
        'source': 'temp-line',
        'paint': {
            'line-color': lineColor,
            'line-width': 4,
            'line-dasharray': [2, 2]
        }
    });
    
    // ì„ì‹œ ì  ì¶”ê°€
    map.addSource('temp-points', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': currentCoordinates.map(coord => ({
                'type': 'Feature',
                'geometry': {
                    'type': 'Point',
                    'coordinates': coord
                }
            }))
        }
    });
    
    map.addLayer({
        'id': 'temp-points',
        'type': 'circle',
        'source': 'temp-points',
        'paint': {
            'circle-radius': 5,
            'circle-color': lineColor,
            'circle-stroke-width': 2,
            'circle-stroke-color': '#ffffff'
        }
    });
}

map.on('load', async () => {
    try {
        // GeoJSON íŒŒì¼ ë¡œë“œ
        geojsonData = await loadAndConvertGeoJSON('Arcgis_railroad_extracted.json');
        
        // ë°ì´í„° ì†ŒìŠ¤ ì¶”ê°€
        map.addSource('railways', {
            'type': 'geojson',
            'data': geojsonData
        });

        // ë ˆì´ì–´ ì¶”ê°€
        map.addLayer({
            'id': 'railway-lines',
            'type': 'line',
            'source': 'railways',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': ['get', 'color'],
                'line-width': 3
            }
        });

        // í´ë¦­ ì´ë²¤íŠ¸ - ê·¸ë¦¬ê¸° ëª¨ë“œ, í¸ì§‘ ëª¨ë“œ, ì¼ë°˜ ëª¨ë“œ êµ¬ë¶„
        map.on('click', (e) => {
            if (isDrawing) {
                // ê·¸ë¦¬ê¸° ëª¨ë“œ: ì¢Œí‘œ ì¶”ê°€
                currentCoordinates.push([e.lngLat.lng, e.lngLat.lat]);
                document.getElementById('coord-count').textContent = `åº§æ¨™æ•°: ${currentCoordinates.length}`;
                updateTempLine();
            } else if (isEditMode) {
                // í¸ì§‘ ëª¨ë“œ: ì„ ë¡œ ì„ íƒ
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['railway-lines']
                });

                if (features.length > 0) {
                    // ì„ íƒëœ featureì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const clickedLabel = features[0].properties.label;
                    const featureIndex = geojsonData.features.findIndex(f => f.properties.label === clickedLabel);

                    if (featureIndex !== -1) {
                        selectLineForEditing(featureIndex, [e.lngLat.lng, e.lngLat.lat]);
                    }
                }
            } else {
                // ì¼ë°˜ ëª¨ë“œ: ì„ ë¡œ ì •ë³´ í‘œì‹œ
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['railway-lines']
                });

                if (features.length > 0) {
                    const properties = features[0].properties;
                    const operatorTypeName = operatorTypeMap[properties.operatorType] || properties.operatorType;
                    const railwayTypeName = railwayTypeMap[properties.railwayType] || properties.railwayType;

                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div class="popup-title">${properties.label}</div>
                            <div class="popup-row">
                                <span class="popup-label">é‹å–¶ä¼šç¤¾:</span> ${properties.operator}
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">äº‹æ¥­è€…åŒºåˆ†:</span> ${operatorTypeName}
                            </div>
                            <div class="popup-row">
                                <span class="popup-label">è·¯ç·šç¨®é¡:</span> ${railwayTypeName}
                            </div>
                        `)
                        .addTo(map);
                }
            }
        });

        // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½
        map.on('mouseenter', 'railway-lines', () => {
            if (!isDrawing) {
                map.getCanvas().style.cursor = 'pointer';
            }
        });
        map.on('mouseleave', 'railway-lines', () => {
            if (!isDrawing) {
                map.getCanvas().style.cursor = '';
            }
        });

        // ì „ì²´ ë…¸ì„ ì´ ë³´ì´ë„ë¡ ë§µ ì¡°ì •
        const bounds = new mapboxgl.LngLatBounds();
        geojsonData.features.forEach(feature => {
            feature.geometry.coordinates.forEach(line => {
                line.forEach(coord => {
                    bounds.extend(coord);
                });
            });
        });
        map.fitBounds(bounds, { padding: 50 });
        
    } catch (error) {
        console.error('GeoJSON ë¡œë“œ ì‹¤íŒ¨:', error);
    }
});
</script>
</body>
</html>
